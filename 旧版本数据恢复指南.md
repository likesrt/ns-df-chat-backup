# 旧版本 (1.0.0) 数据恢复完整指南

本文档详细说明如何将旧版本 NodeSeek 私信备份脚本的数据迁移到新版本 (2.0.0)。

## 📋 版本差异概览

### 旧版本 (1.0.0)

- **支持站点**: 仅 NodeSeek
- **数据库名称**: `nodeseek_chat_{userId}`
- **配置存储**: `webdav_config_{userId}` (每个用户独立)
- **备份文件名**: `nodeseek_chat_backup_*.json`
- **备份路径**: `/nodeseek_messages_backup/` (扁平结构)
- **备份内容**: 仅聊天记录

### 新版本 (2.0.0)

- **支持站点**: NodeSeek + DeepFlood
- **数据库名称**: `ns_chat_{userId}` 或 `df_chat_{userId}`
- **配置存储**: `webdav_config` 和 `r2worker_config` (全局共享)
- **备份文件名**: `ns_chat_backup_*.json` 或 `df_chat_backup_*.json`
- **备份路径**: `/{basePath}/{siteId}/{userId}/` (层级结构)
- **备份内容**: 聊天记录 + 用户配置

## 🔄 数据兼容性说明

### ✅ 完全兼容的字段

新版本可以自动识别并转换旧版本的以下字段:

| 旧版本字段          | 新版本字段    | 说明                     |
| ------------------- | ------------- | ------------------------ |
| `member_id`         | `member_id`   | 主键,必须存在            |
| `member_name`       | `member_name` | 用户名称                 |
| `content`           | `content`     | 消息内容                 |
| `created_at`        | `created_at`  | 创建时间                 |
| `sender_id`         | `sender_id`   | 发送者 ID                |
| `receiver_id`       | `receiver_id` | 接收者 ID                |
| `id` / `message_id` | `message_id`  | 消息 ID (兼容两种字段名) |
| `viewed`            | `viewed`      | 已读状态                 |
| `updated_at`        | `updated_at`  | 更新时间                 |

### 🆕 新增字段 (自动补充)

旧版本备份中不存在的字段,恢复时会自动使用默认值:

| 新字段     | 默认值  | 说明           |
| ---------- | ------- | -------------- |
| `isLatest` | `false` | 是否为最新聊天 |
| `remark`   | `""`    | 联系人备注     |

### ⚠️ 注意事项

- 旧版本没有 `config` 字段,恢复后需要手动重新配置 WebDAV/R2
- 旧版本备份中如果缺少必需字段,该条记录会跳过并记录错误
- 恢复操作会**完全覆盖**当前数据,无法撤销

## 📝 迁移方法一: WebDAV 备份恢复 (推荐)

### 前置条件

- 已在旧版本中成功创建过 WebDAV 备份
- 知道 WebDAV 服务器的访问信息

### 详细步骤

#### 第一步: 在旧版本中创建最终备份

1. 访问 NodeSeek 私信页面
2. 点击"历史私信"按钮
3. 点击"立即备份"按钮
4. 等待提示"备份成功"
5. **记录备份文件名**: `nodeseek_chat_backup_YYYYMMDD_HHMMSS.json`

#### 第二步: 更新到新版本脚本


1. 点击 [NodeSeek/DeepFlood 私信备份脚本一键直达](https://github.com/likesrt/ns-df-chat-backup/raw/refs/heads/main/ns-df-chat-backup.user.js) 

4. 确认更新到 2.0.0 版本



#### 第三步: 配置 WebDAV 指向旧备份路径

1. 刷新 NodeSeek 页面
2. 点击"历史私信"按钮
3. 点击"备份设置"按钮
4. 填写 WebDAV 配置:

   ```
   ☑️ 启用 WebDAV 备份

   服务器地址: https://dav.jianguoyun.com/dav  (示例)
   用户名: your_username
   密码: your_password
   备份路径: /nodeseek_messages_backup/  ⚠️ 重要: 使用旧路径
   ```

5. 点击"保存配置"

#### 第四步: 从备份恢复数据

1. 在"历史私信"窗口中点击"从备份恢复"按钮
2. 选择"WebDAV"
3. 在备份列表中找到第一步创建的备份文件
4. 点击"恢复"按钮
5. 确认提示:
   ```
   ⚠️ 此操作将完全覆盖本地数据，无法撤销！
   确定要从 WebDAV 恢复此备份吗？
   ```
6. 点击"确定"
7. 等待恢复完成提示
8. 页面会自动刷新

#### 第五步: 验证数据并调整配置

1. 刷新后点击"历史私信"检查聊天记录是否完整
2. 检查消息内容、时间、用户名是否正确
3. **(可选)** 调整备份路径为新版本默认路径:
   - 点击"备份设置"
   - 将备份路径改为: `/ns_df_messages_backup/`
   - 点击"保存配置"
   - 点击"立即备份"创建新版本格式的备份

#### 第六步: 清理旧数据 (可选)

如果确认数据迁移成功,可以清理旧版本数据:

1. 打开浏览器开发者工具 (F12)
2. 切换到"Application" / "存储"标签
3. 展开"IndexedDB"
4. 找到并删除 `nodeseek_chat_{userId}` 数据库
5. 切换到"Console"标签,执行:
   ```javascript
   // 删除旧配置
   Object.keys(localStorage).forEach((key) => {
     if (key.startsWith("webdav_config_")) {
       localStorage.removeItem(key);
       console.log("已删除:", key);
     }
   });
   ```


## ❓ 常见问题


### Q: 导入后聊天记录数量不对

**A**: 检查导出的 JSON 文件:

1. 用文本编辑器打开 JSON 文件
2. 搜索 `"chats":` 字段
3. 确认数组长度和内容完整性
4. 如果文件损坏,重新导出

### Q3: 导入后缺少配置信息

**A**: 这是正常的,因为:

- 旧版本不备份配置信息
- 新版本配置结构不同
- 需要手动重新配置 WebDAV/R2

### Q4: 某些聊天记录显示"未知用户"

**A**: 可能原因:

- 旧备份中 `member_name` 字段为空
- 数据损坏

**不影响功能**,可以通过以下方式修复:

1. 访问该用户的聊天页面
2. 脚本会自动更新用户名

### Q5: 导入时出现"保存失败"错误

**A**: 检查:

1. 浏览器存储空间是否充足
2. IndexedDB 是否被禁用
3. 控制台中的详细错误信息

**解决方法**:

- Chrome: 设置 → 隐私和安全 → 网站设置 → 查看所有网站的权限和数据存储的数据
- 清理其他网站数据释放空间

### Q6: 可以同时保留旧版本和新版本吗?

**A**: 可以,但不建议:

- 两个版本使用不同的数据库
- 不会互相干扰
- 但容易造成数据不一致
- 建议迁移完成后卸载旧版本

### Q7: 如何确认迁移成功?

**A**: 检查清单:

- ✅ 聊天记录数量与旧版本一致
- ✅ 随机抽查消息内容正确
- ✅ 时间戳显示正确
- ✅ 用户名显示正确
- ✅ 能正常创建新备份
- ✅ 能正常恢复备份

### Q8: 迁移失败,如何回退?

**A**: 旧数据不会被删除:

1. 卸载新版本脚本
2. 重新安装旧版本脚本
3. 旧数据库 `nodeseek_chat_{userId}` 仍然存在
4. 旧配置 `webdav_config_{userId}` 仍然存在

#

### Q10: 迁移后备注信息会丢失吗?

**A**: 不会:

- 备注信息 (`remark` 字段) 会保留
- 如果旧备份没有备注,恢复后为空
- 可以在新版本中重新添加备注

## 🔧 细节

### 数据规范化逻辑

新版本恢复时会自动规范化数据,代码位置: `ns-df-chat-backup.user.js` 第 2808-2821 行

```javascript
const normalizedChat = {
  member_id: chat.member_id, // 主键 (必需)
  member_name: chat.member_name || "未知用户", // 用户名 (兼容缺失)
  content: chat.content || "", // 消息内容
  created_at: chat.created_at || new Date().toISOString(), // 创建时间
  sender_id: chat.sender_id || 0, // 发送者ID
  receiver_id: chat.receiver_id || 0, // 接收者ID
  message_id: chat.message_id || chat.id || 0, // 消息ID (兼容 id 字段)
  viewed: chat.viewed ?? false, // 已读状态
  updated_at: chat.updated_at || new Date().toISOString(), // 更新时间
  isLatest: chat.isLatest ?? false, // 最新聊天标记 (新增)
  remark: chat.remark || "", // 备注 (新增)
};
```

### 字段兼容性矩阵

| 旧版本字段    | 新版本处理          | 缺失时默认值               |
| ------------- | ------------------- | -------------------------- |
| `member_id`   | 直接使用            | **无** (必需,否则跳过)     |
| `member_name` | 直接使用            | `'未知用户'`               |
| `content`     | 直接使用            | `''`                       |
| `created_at`  | 直接使用            | `new Date().toISOString()` |
| `sender_id`   | 直接使用            | `0`                        |
| `receiver_id` | 直接使用            | `0`                        |
| `id`          | 映射为 `message_id` | `0`                        |
| `message_id`  | 直接使用            | `0`                        |
| `viewed`      | 直接使用            | `false`                    |
| `updated_at`  | 直接使用            | `new Date().toISOString()` |
| _(无)_        | 新增 `isLatest`     | `false`                    |
| _(无)_        | 新增 `remark`       | `''`                       |

